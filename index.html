<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta Placa</title>
  <style>
    body{font-family:system-ui,Arial;max-width:720px;margin:30px auto;padding:0 16px}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:16px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    button{margin-top:10px;padding:12px 14px;border:0;border-radius:10px;cursor:pointer}
    .muted{color:#666;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .k{color:#6b7280;font-size:12px;margin:0}
    .v{margin:0;font-weight:600}
  </style>
</head>
<body>
  <h2>Consulta Vehicular</h2>

  <div class="card">
    <label for="placa">Placa</label>
    <input id="placa" placeholder="Ej: ABC-123" autocomplete="off" />
    <button id="btn">Consultar</button>
    <p class="muted">Enter tambi√©n consulta.</p>
  </div>

  <h3>Resultado</h3>
  <div id="status" class="muted">Sin consulta a√∫n.</div>

  <div id="result" class="card" style="display:none;margin-top:10px;">
    <div class="row">
      <div><p class="k">PLACA</p><p class="v" id="rPlaca"></p></div>
      <div><p class="k">ESTADO</p><p class="v" id="rEstado"></p></div>
      <div><p class="k">C√ìDIGO</p><p class="v" id="rCodigo"></p></div>
      <div><p class="k">EMPRESA</p><p class="v" id="rEmpresa"></p></div>
      <div><p class="k">PROPIETARIO</p><p class="v" id="rProp"></p></div>
      <div><p class="k">CONDUCTOR</p><p class="v" id="rCond"></p></div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycby3BteyfVfqrfmygW1ZjC875COt7ZsZKU2pRwGUzz7IIVr1eE4A-UGFMQOwYCYvM-KO5Q/exec";
  const $ = (id) => document.getElementById(id);
  const $placa = $("placa");
  const $btn   = $("btn");
  const $status= $("status");
  const $result= $("result");

  function normalizePlaca(s){
    return String(s).replace(/[^A-Z0-9]/gi, "").toUpperCase();
  }

  function paint(data){
    $("rPlaca").textContent   = data.placa || "-";
    $("rEstado").textContent  = data.estado || "-";
    $("rCodigo").textContent  = data.codigo || "-";
    $("rEmpresa").textContent = data.empresa || "-";
    $("rProp").textContent    = data.propietario || "-";
    $("rCond").textContent    = data.conductor || "-";

    $("rEstado").style.color =
      (String(data.estado).toUpperCase() === "VIGENTE") ? "green" : "red";
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
      let done = false;

      window[cb] = (data) => {
        if (done) return;
        done = true;
        resolve(data);
        cleanup();
      };

      const script = document.createElement("script");
      script.async = true;
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;

      // üëá esto te ayuda a ver la URL exacta en consola
      console.log("JSONP URL =>", script.src);

      script.onerror = () => {
        if (done) return;
        done = true;
        reject(new Error("Script load error (bloqueado/404)"));
        cleanup();
      };

      function cleanup() {
        try { delete window[cb]; } catch (e) { window[cb] = undefined; }
        if (script.parentNode) script.parentNode.removeChild(script);
      }

      document.body.appendChild(script);

      setTimeout(() => {
        if (done) return;
        done = true;
        reject(new Error("Timeout (no respondi√≥ el callback)"));
        cleanup();
      }, 15000);
    });
  }

  async function consultar(){
    const placa = normalizePlaca($placa.value.trim());

    if(!placa){
      $status.textContent = "Ingresa una placa.";
      $result.style.display = "none";
      return;
    }

    $status.textContent = "Consultando...";
    $result.style.display = "none";

    try {
      const url = `${API_URL}?placa=${encodeURIComponent(placa)}`; 
      const json = await jsonp(url);

      if(!json.ok){
        $status.textContent = "Error: " + (json.error || "desconocido");
        return;
      }
      if(!json.found){
        $status.textContent = `No se encontr√≥ la placa ${placa}`;
        return;
      }

      $status.textContent = "Encontrado ‚úÖ";
      paint(json);
      $result.style.display = "block";

    } catch (err) {
      $status.textContent = "JSONP fall√≥: " + err.message;
      console.error("JSONP error:", err);
    }
  }

  $btn.addEventListener("click", consultar);
  $placa.addEventListener("keydown", (e)=>{ if(e.key==="Enter") consultar(); });
</script>
</body>
</html>
